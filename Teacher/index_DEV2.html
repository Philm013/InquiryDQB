<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>InquiryDQB - The Complete App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Tldraw CSS -->
    <link rel="stylesheet" href="https://esm.sh/tldraw@3.5.0/tldraw.css" />
    
    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    
    <!-- Import Map -->
    <script type="importmap">
    { "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "tldraw": "https://esm.sh/tldraw@3.5.0?external=react,react-dom",
        "peerjs": "https://esm.sh/peerjs@1.5.2"
    }}
    </script>

    <style>
        :root {
            --primary: #5e5ce6; --bg: #f2f2f7; --card: #ffffff; --text: #1d1d1f;
            --c-notice: #a2d2ff; --c-wonder: #ffafcc; --c-idea: #cdb4db; --c-test: #b9fbc0;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--font); background: var(--bg); color: var(--text); overflow: hidden; overscroll-behavior: none; }

        .hidden { display: none !important; }
        .layer { position: absolute; inset: 0; }
        .pointer-events-none { pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        
        .btn { padding: 10px 16px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; background: var(--card); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; }

        /* Dashboard */
        #dashboard { z-index: 100; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding-top: 60px; overflow-y: auto; }
        .dash-card { background: var(--card); width: 90%; max-width: 450px; padding: 30px; border-radius: 24px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .role-row { display: flex; gap: 15px; justify-content: center; margin: 20px 0; }
        .role-btn { flex: 1; padding: 20px; background: #f9f9f9; border-radius: 16px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .role-btn.selected { border-color: var(--primary); background: #eef2ff; color: var(--primary); transform: scale(1.02); }
        .avatar-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; justify-content: flex-start; }
        .avatar-opt { min-width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: #f2f2f7; cursor: pointer; border: 2px solid transparent; }
        .avatar-opt.selected { border-color: var(--primary); background: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 10px; }
        .recent-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; text-align: left; }
        .recent-item:hover { background: #f9f9f9; }

        /* Teacher UI */
        .teacher-bar { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 8px; border-radius: 16px; box-shadow: 0 4px 25px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 8px; pointer-events: auto; }
        .tool-btn { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; transition: background 0.1s; position: relative; }
        .tool-btn:hover { background: #f2f2f7; }
        .tool-btn::after { content: attr(title); position: absolute; left: 55px; background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none; white-space: nowrap; transition: 0.2s; z-index: 99; }
        .tool-btn:hover::after { opacity: 1; }
        .sep { height: 1px; background: #e5e5ea; margin: 2px 0; }
        
        .zone-ctx { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); background: #1d1d1f; color: white; padding: 8px 20px; border-radius: 50px; display: flex; gap: 15px; pointer-events: auto; animation: slideDown 0.3s; z-index: 500; }
        .zone-ctx.magnet-active { background: var(--primary); box-shadow: 0 0 20px var(--primary); }
        @keyframes slideDown { from{transform:translate(-50%,-100%);opacity:0} to{transform:translate(-50%,0);opacity:1} }

        /* User Roster */
        .roster { position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; pointer-events: auto; }
        .user-pill { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .user-pill button { background: #eee; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 0.7rem; }
        .user-pill.co-host { background: #eef2ff; border: 1px solid var(--primary); }

        /* Student-Only View */
        #student-view { z-index: 50; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .student-card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .note-btn { display: flex; flex-direction: column; align-items: center; padding: 20px; border-radius: 16px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; color: #333; }
        .note-btn:active { transform: scale(0.95); }

        /* Timer Widget */
        .timer-widget { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: #ff3b30; color: white; padding: 8px 20px; border-radius: 30px; font-weight: bold; font-family: monospace; font-size: 1.2rem; box-shadow: 0 5px 20px rgba(255, 59, 48, 0.4); pointer-events: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0%{transform:translateX(-50%) scale(1);} 50%{transform:translateX(-50%) scale(1.05);} 100%{transform:translateX(-50%) scale(1);} }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; }
        textarea { width: 100%; height: 120px; margin: 15px 0; padding: 12px; border-radius: 12px; border: 1px solid #ccc; font-family: inherit; font-size: 1rem; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-200%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; transition: 0.3s; z-index: 3000; font-weight: 500; }
        #toast.visible { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div id="dashboard" class="layer">
    <div class="dash-card">
        <h1 style="margin:0; background:-webkit-linear-gradient(45deg,#5e5ce6,#ff2d55);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:2.5rem;">InquiryDQB</h1>
        <p style="color:#888; margin-top:5px;">Complete Edition</p>
        <div class="role-row">
            <div class="role-btn" id="role-student" onclick="App.setRole('student')"><div style="font-size:2rem">üéì</div>Student</div>
            <div class="role-btn" id="role-teacher" onclick="App.setRole('teacher')"><div style="font-size:2rem">üë®‚Äçüè´</div>Teacher</div>
        </div>
        <div id="setup" class="hidden" style="text-align:left;">
            <label style="font-weight:600; margin-left:5px;">Name</label>
            <input type="text" id="username" placeholder="Your Name" style="width:100%; padding:12px; margin:5px 0 15px; border-radius:10px; border:1px solid #ccc;">
            <label style="font-weight:600; margin-left:5px;">Avatar</label>
            <div class="avatar-scroll" id="avatar-list"></div>
            <div id="teacher-ops" class="hidden" style="margin-top:20px;">
                <button class="btn btn-primary" style="width:100%" onclick="App.start()">Start New Class</button>
                <div id="recent-list" style="margin-top:15px; font-size:0.9rem; border-top:1px solid #eee; padding-top:10px;"></div>
            </div>
            <div id="student-ops" class="hidden" style="margin-top:20px;">
                <input type="text" id="join-id" placeholder="Class ID" style="width:100%; padding:12px; text-align:center; border-radius:10px; border:1px solid #ccc; font-family:monospace;">
                <button class="btn" style="width:100%; margin-top:8px;" onclick="App.start()">Join Class</button>
                <button class="btn btn-primary" style="width:100%; margin-top:8px;" onclick="App.scanQR()">üì∑ Scan QR</button>
            </div>
        </div>
    </div>
</div>

<div id="workspace" class="layer hidden pointer-events-auto"></div>
<div id="student-view" class="layer hidden pointer-events-auto"></div>

<div id="toast"></div>

<div id="modal-share" class="modal-overlay hidden"><div class="modal-box" style="text-align:center"><h3>Join Class</h3><canvas id="qr-canvas"></canvas><p id="share-id" style="font-family:monospace; background:#f2f2f7; padding:10px; border-radius:8px;"></p><button class="btn" style="width:100%; margin-top:15px" onclick="App.ui.closeModals()">Close</button></div></div>
<div id="modal-note" class="modal-overlay hidden"><div class="modal-box"><h3 id="note-title">Add Note</h3><textarea id="note-input"></textarea><button id="send-note-btn" class="btn btn-primary" style="width:100%">Post</button></div></div>
<div id="modal-scan" class="modal-overlay hidden"><div class="modal-box"><h3>Scan QR</h3><div id="reader" style="width:100%"></div><button class="btn" style="width:100%; margin-top:10px" onclick="App.stopScan()">Close</button></div></div>

<script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { Tldraw, createTLStore, defaultShapeUtils, getSnapshot, uniqueId, throttle, loadSnapshot, createShapeId } from 'tldraw';
    import { Peer } from 'peerjs';

    // --- CONFIG ---
    const AVATARS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏'];
    const NOTES = {
        NOTICE: { color: 'light-blue', hex: '#a2d2ff' }, WONDER: { color: 'light-red', hex: '#ffafcc' },
        IDEA:   { color: 'light-violet', hex: '#cdb4db' }, TEST:   { color: 'light-green', hex: '#b9fbc0' }
    };

    const DB = {
        async init() { return new Promise(r => { const q = indexedDB.open('DQB_Complete_V4', 1); q.onupgradeneeded=e=>e.target.result.createObjectStore('b',{keyPath:'id'}); q.onsuccess=e=>r(e.target.result); }); },
        async save(id, snap) { const db=await this.init(); db.transaction('b','readwrite').objectStore('b').put({id, snap, d:Date.now()}); },
        async list() { const db=await this.init(); return new Promise(r=>{ const q=db.transaction('b','readonly').objectStore('b').getAll(); q.onsuccess=()=>r(q.result.sort((a,b)=>b.d-a.d)); }); }
    };

    // --- REACT COMPONENTS ---

    function TimerDisplay({ endTime }) {
        const [left, setLeft] = useState(0);
        useEffect(() => {
            if(!endTime) { setLeft(0); return; }
            const i = setInterval(() => {
                const diff = Math.max(0, Math.ceil((endTime - Date.now())/1000));
                setLeft(diff);
                if(diff <= 0) clearInterval(i);
            }, 1000);
            return () => clearInterval(i);
        }, [endTime]);

        if(!endTime || left <= 0) return null;
        const m = Math.floor(left / 60);
        const s = left % 60;
        return React.createElement('div', { className: 'timer-widget' }, `${m}:${s.toString().padStart(2,'0')}`);
    }

    function UserRoster({ editor }) {
        const [users, setUsers] = useState([]);
        useEffect(() => {
            if (!editor) return;
            const update = () => {
                const presences = editor.store.allRecords().filter(r => r.typeName === 'instance_presence' && r.userId !== editor.user.getId());
                setUsers(presences.map(p => ({
                    id: p.userId,
                    peerId: p.meta?.peerId,
                    name: p.userName,
                    isCoHost: p.meta?.isCoHost || false
                })));
            };
            const unsubscribe = editor.store.listen(update, { scope: 'presence' });
            return unsubscribe;
        }, [editor]);

        const toggleCoHost = (user) => {
            if (!user.peerId) return;
            App.sendTo(user.peerId, { type: 'promote', promote: !user.isCoHost });
        };

        if (users.length === 0) return null;
        return React.createElement('div', { className: 'roster' },
            users.map(u => React.createElement('div', { key: u.id, className: `user-pill ${u.isCoHost ? 'co-host' : ''}` },
                React.createElement('span', null, u.name),
                React.createElement('button', { onClick: () => toggleCoHost(u) }, u.isCoHost ? 'Demote' : 'Promote')
            ))
        );
    }

    function TeacherTools({ editor, boardId, onSetTimer }) {
        const addZone = () => {
            const { w, h } = editor.getViewportScreenBounds();
            const c = editor.screenToPage({x: w/2, y: h/2});
            editor.createShape({ type: 'frame', x: c.x - 250, y: c.y - 200, props: { name: 'Activity Zone', w: 500, h: 400 } });
        };
        const addCER = () => {
            const { w, h } = editor.getViewportScreenBounds();
            const c = editor.screenToPage({x: w/2, y: h/2});
            ['Claim','Evidence','Reasoning'].forEach((t, i) => {
                editor.createShape({ type: 'frame', x: (c.x - 450) + (i*310), y: c.y - 200, props: { name: t, w: 300, h: 500 } });
            });
        };
        const startTimer = () => onSetTimer(Date.now() + 300000);
        const spotlight = () => {
            const cam = editor.getCamera();
            App.broadcast({ type: 'spotlight', cam });
            App.ui.toast("üëÄ Spotlight Active");
        };
        const exportImg = async () => {
            const blob = await editor.getSvg(editor.getCurrentPageShapeIds(), { scale: 1, background: true });
            if(!blob) return;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `DQB_Snapshot.svg`;
            a.click();
            App.ui.toast("üì∏ Snapshot Saved");
        };

        return React.createElement('div', { className: 'teacher-bar' },
            React.createElement('div', { className: 'tool-btn', onClick: addZone, title: 'Add Zone' }, '‚¨úÔ∏è'),
            React.createElement('div', { className: 'tool-btn', onClick: addCER, title: 'CER Layout' }, 'üî¨'),
            React.createElement('div', { className: 'sep' }),
            React.createElement('div', { className: 'tool-btn', onClick: startTimer, title: '5m Timer' }, '‚è±Ô∏è'),
            React.createElement('div', { className: 'tool-btn', onClick: spotlight, title: 'Spotlight' }, 'üëÄ'),
            React.createElement('div', { className: 'tool-btn', onClick: exportImg, title: 'Snapshot' }, 'üì∏'),
            React.createElement('div', { className: 'sep' }),
            React.createElement('div', { className: 'tool-btn', onClick: ()=>App.ui.share(boardId), title: 'Share' }, 'üì°'),
            React.createElement('div', { className: 'tool-btn', onClick: ()=>location.reload(), title: 'Exit' }, 'üè†')
        );
    }

function AutoLayoutEngine({ editor }) {
        // --- Shared Layout Calculation ---
        // Returns the list of updates needed to arrange shapes in a flow
        const getFlowUpdates = (frameId, shapesToLayout, containerW) => {
            const updates = [];
            const PADDING = 20;
            const GAP = 15;
            
            let currentX = PADDING;
            let currentY = PADDING;
            let rowHeight = 0;

            shapesToLayout.forEach((shape) => {
                // Get precise dimensions for drawings/notes/images
                const geo = editor.getShapeGeometry(shape);
                const w = geo.bounds.w;
                const h = geo.bounds.h;

                // Wrap to next line if needed
                if (currentX + w + PADDING > containerW) {
                    currentX = PADDING;
                    currentY += rowHeight + GAP;
                    rowHeight = 0;
                }

                // Add to updates list
                updates.push({ id: shape.id, type: shape.type, x: currentX, y: currentY });

                // Advance cursors
                rowHeight = Math.max(rowHeight, h);
                currentX += w + GAP;
            });

            return { updates, totalHeight: currentY + rowHeight + PADDING };
        };

        useEffect(() => {
            if (!editor) return;

            const handleEvent = throttle((event) => {
                
                // --- 1. LIVE PREVIEW (Push siblings aside) ---
                if (event.name === 'pointer_move') {
                    // 1. Get the shape being dragged
                    const draggingId = editor.getEditingShapeId();
                    if (!draggingId || editor.getInstanceState().isChangingStyle) return;

                    const draggingShape = editor.getShape(draggingId);
                    if (!draggingShape || draggingShape.type === 'frame') return;

                    // 2. Find the frame under the mouse
                    const shapePageBounds = editor.getShapePageBounds(draggingId);
                    if (!shapePageBounds) return;
                    
                    const shapeCenter = { 
                        x: shapePageBounds.x + shapePageBounds.w/2, 
                        y: shapePageBounds.y + shapePageBounds.h/2 
                    };

                    const frames = editor.getCurrentPageShapes().filter(s => s.type === 'frame');
                    const targetFrame = frames.find(f => {
                        const b = editor.getShapePageBounds(f.id);
                        return b && shapeCenter.x > b.x && shapeCenter.x < b.maxX && 
                                    shapeCenter.y > b.y && shapeCenter.y < b.maxY;
                    });

                    if (targetFrame) {
                        // 3. Simulate the list including the dragging shape
                        const siblings = editor.store.allRecords()
                            .filter(s => s.typeName === 'shape' && s.parentId === targetFrame.id && s.id !== draggingId);

                        // Calculate relative position for sorting
                        const frameBounds = editor.getShapePageBounds(targetFrame.id);
                        const relativeY = shapePageBounds.y - frameBounds.y;
                        const relativeX = shapePageBounds.x - frameBounds.x;

                        const simList = [...siblings, { ...draggingShape, x: relativeX, y: relativeY }];

                        // Sort visually
                        simList.sort((a,b) => {
                            const rowA = Math.floor(a.y / 50); // Group by rough rows
                            const rowB = Math.floor(b.y / 50);
                            if (rowA !== rowB) return rowA - rowB;
                            return a.x - b.x;
                        });

                        // Calculate layout
                        const { updates } = getFlowUpdates(targetFrame.id, simList, targetFrame.props.w);

                        // Only move the siblings, NOT the dragged item (user holds that)
                        const siblingUpdates = updates.filter(u => u.id !== draggingId);
                        if (siblingUpdates.length > 0) editor.updateShapes(siblingUpdates);
                    }
                }

                // --- 2. DROP & SNAP (Finalize position) ---
                if (event.name === 'pointer_up') {
                    // 1. Get the shape that was just dropped
                    const selectedShape = editor.getOnlySelectedShape();
                    
                    if (selectedShape && selectedShape.type !== 'frame') {
                        // 2. Find frame
                        const bounds = editor.getShapePageBounds(selectedShape.id);
                        if (!bounds) return;
                        
                        const center = {x: bounds.x + bounds.w/2, y: bounds.y + bounds.h/2};
                        const frames = editor.getCurrentPageShapes().filter(s => s.type === 'frame');
                        const targetFrame = frames.find(f => {
                            const b = editor.getShapePageBounds(f.id);
                            return b && center.x > b.x && center.x < b.maxX && center.y > b.y && center.y < b.maxY;
                        });

                        if (targetFrame) {
                            // 3. Reparent if needed
                            if (selectedShape.parentId !== targetFrame.id) {
                                editor.reparentShapes([selectedShape.id], targetFrame.id);
                            }

                            // 4. WAIT for reparenting to finish, then SNAP everything
                            setTimeout(() => {
                                // Re-fetch all children (now including the dropped one)
                                const allChildren = editor.store.allRecords()
                                    .filter(s => s.typeName === 'shape' && s.parentId === targetFrame.id);
                                
                                // Sort them strictly by their current approximate positions
                                allChildren.sort((a,b) => {
                                    const rowA = Math.floor(a.y / 50);
                                    const rowB = Math.floor(b.y / 50);
                                    if (rowA !== rowB) return rowA - rowB;
                                    return a.x - b.x;
                                });

                                // Calculate final positions
                                const { updates, totalHeight } = getFlowUpdates(targetFrame.id, allChildren, targetFrame.props.w);

                                // Apply updates to EVERYTHING (snaps the dropped note into place)
                                editor.updateShapes(updates);

                                // Auto-resize frame height if needed
                                if (totalHeight > targetFrame.props.h) {
                                    editor.updateShapes([{ id: targetFrame.id, type: 'frame', props: { w: targetFrame.props.w, h: totalHeight }}]);
                                }
                            }, 100); // 100ms delay ensures state is consistent
                        }
                    }
                }
            }, 30); // Throttle frequency

            const unsubscribe = editor.on('event', handleEvent);
            return () => unsubscribe();
        }, [editor]);

        return null;
    }
    function StudentView({ store }) {
        const post = (type) => {
            const m = document.getElementById('modal-note');
            const t = document.getElementById('note-title');
            const i = document.getElementById('note-input');
            const b = document.getElementById('send-note-btn');
            
            t.innerText = `Add ${type.charAt(0)+type.slice(1).toLowerCase()} Note`;
            i.value = '';
            m.classList.remove('hidden');
            i.focus();

            b.onclick = () => {
                if(!i.value.trim()) return;
                store.put([{
                    id: createShapeId(), typeName: 'shape', type: 'note',
                    x: Math.random() * 200 - 100, y: Math.random() * 200 - 100,
                    props: { text: i.value, color: NOTES[type].color }
                }]);
                App.ui.closeModals();
                App.ui.toast("Note Sent!");
            };
        };

        return React.createElement('div', { id: 'student-view', className: 'layer' },
            React.createElement('div', { className: 'student-card' },
                React.createElement('h2', null, 'Contribute to the Board'),
                React.createElement('p', { style:{color:'#666'} }, 'Your teacher will place your notes.'),
                React.createElement('div', { className: 'btn-grid' },
                    React.createElement('button', { className: 'note-btn', style:{background:NOTES.NOTICE.hex}, onClick:()=>post('NOTICE') }, 'üì¢ Notice'),
                    React.createElement('button', { className: 'note-btn', style:{background:NOTES.WONDER.hex}, onClick:()=>post('WONDER') }, '‚ùì Wonder')
                ),
                 React.createElement('div', { className: 'btn-grid' },
                    React.createElement('button', { className: 'note-btn', style:{background:NOTES.IDEA.hex}, onClick:()=>post('IDEA') }, 'üí° Idea'),
                    React.createElement('button', { className: 'note-btn', style:{background:NOTES.TEST.hex}, onClick:()=>post('TEST') }, 'üß™ Testable')
                )
            )
        );
    }

function AppCore({ role, boardId, snap, peerId }) {
        const [store] = useState(() => {
            const s = createTLStore({ shapeUtils: defaultShapeUtils });
            if(snap) loadSnapshot(s, snap);
            return s;
        });
        const [editor, setEditor] = useState(null);
        const [timer, setTimer] = useState(0);
        const [magnetZone, setMagnetZone] = useState(null);
        const [isCoHost, setIsCoHost] = useState(role === 'teacher');
        
        // Refs to manage connection state without triggering re-renders
        const connectionsRef = useRef(new Map());
        const heartbeatIntervalRef = useRef(null);
        const peerRef = useRef(null);
        const retryTimeoutRef = useRef(null);

        useEffect(() => {
            // 1. Initialize Peer
            const peer = new Peer(peerId, { debug: 1 });
            peerRef.current = peer;

            // --- SHARED UTILS ---
            const handleData = (c, d) => {
                try {
                    const m = JSON.parse(d);
                    
                    // Heartbeat handling
                    if (m.type === 'ping') { c.send(JSON.stringify({ type: 'pong' })); return; }
                    if (m.type === 'pong') { c.lastPong = Date.now(); return; }

                    // App logic
                    if(m.type==='init') { loadSnapshot(store, m.snap); setTimer(m.timer || 0); }
                    if(m.type==='update') {
                        if(role === 'teacher' && magnetZone && m.changes.added) {
                            for(let key in m.changes.added) {
                                if(m.changes.added[key].type === 'note') m.changes.added[key].parentId = magnetZone;
                            }
                        }
                        store.mergeRemoteChanges(() => {
                            const {added,updated,removed} = m.changes;
                            for(let k in added) store.put([added[k]]);
                            for(let k in updated) store.put([updated[k][1]]);
                            for(let k in removed) store.remove([removed[k].id]);
                        });
                    }
                    if(m.type==='timer') setTimer(m.end);
                    if(m.type==='spotlight' && isCoHost && editor) editor.setCamera(m.cam);
                    if(m.type==='promote') {
                        setIsCoHost(m.promote);
                        if(editor) editor.updateInstanceState({ meta: { ...editor.getInstanceState().meta, isCoHost: m.promote }});
                        App.ui.toast(m.promote ? "You are now a Co-Host!" : "You are a Student again.");
                    }
                } catch(e){ console.error("Data parse error", e); }
            };

            const setupConnection = (c) => {
                c.lastPong = Date.now(); // Initialize heartbeat timestamp
                connectionsRef.current.set(c.peer, c);
                
                c.on('open', () => {
                    console.log(`Connection opened: ${c.peer}`);
                    if(role==='teacher') {
                        c.send(JSON.stringify({type:'init', snap:getSnapshot(store), timer}));
                    } else {
                        App.ui.toast("Connected to Class");
                        // Clear any retry timeouts if we successfully connected
                        if(retryTimeoutRef.current) clearTimeout(retryTimeoutRef.current);
                    }
                });

                c.on('data', (d) => handleData(c, d));

                c.on('close', () => {
                    console.log(`Connection closed: ${c.peer}`);
                    connectionsRef.current.delete(c.peer);
                    
                    // STUDENT RECONNECT LOGIC
                    if (role === 'student') {
                        App.ui.toast("Disconnected. Reconnecting...");
                        retryTimeoutRef.current = setTimeout(() => connectToHost(), 2000);
                    }
                });
                
                c.on('error', (err) => {
                    console.error('Connection error:', err);
                    c.close();
                });
            };

            // --- ROLE SPECIFIC SETUP ---
            
            // STUDENT: Connect to Host
            const connectToHost = () => {
                if (role !== 'student') return;
                // Close existing if any to prevent duplicates
                const existing = connectionsRef.current.get(boardId);
                if (existing && existing.open) return;

                console.log("Attempting to connect to host:", boardId);
                const conn = peer.connect(boardId, { reliable: true });
                setupConnection(conn);
            };

            // TEACHER: Heartbeat Loop
            const startHeartbeat = () => {
                if (role !== 'teacher') return;
                heartbeatIntervalRef.current = setInterval(() => {
                    const now = Date.now();
                    connectionsRef.current.forEach((conn, id) => {
                        // Prune dead connections (no pong in 10s)
                        if (conn.lastPong && (now - conn.lastPong > 10000)) {
                            console.log(`Pruning dead connection: ${id}`);
                            conn.close();
                            connectionsRef.current.delete(id);
                            return;
                        }
                        // Send Ping
                        if (conn.open) conn.send(JSON.stringify({ type: 'ping' }));
                    });
                    // Autosave logic moved here to reduce intervals
                    DB.save(boardId, getSnapshot(store));
                }, 3000); // Ping every 3s
            };

            // --- PEER EVENTS ---

            peer.on('open', (id) => {
                console.log('My Peer ID:', id);
                if(role === 'teacher') {
                    startHeartbeat();
                } else {
                    connectToHost();
                }
            });

            peer.on('connection', (c) => {
                // Incoming connection (Teacher receives student, or Student receives P2P update)
                setupConnection(c);
            });

            peer.on('disconnected', () => {
                console.log('Peer disconnected from signaling server. Reconnecting...');
                peer.reconnect();
            });

            peer.on('error', (err) => {
                console.error('Peer Error:', err.type);
                if (role === 'student' && (err.type === 'peer-unavailable' || err.type === 'network')) {
                    // Host not ready yet or network blip, retry
                    if(!retryTimeoutRef.current) {
                        retryTimeoutRef.current = setTimeout(() => connectToHost(), 2000);
                    }
                }
            });

            // --- EXPOSE GLOBALS FOR UI ---
            if(role === 'teacher') {
                App.broadcast = (msg) => connectionsRef.current.forEach(c => c.open && c.send(JSON.stringify(msg)));
                App.sendTo = (pId, msg) => {
                    const conn = connectionsRef.current.get(pId);
                    if (conn && conn.open) conn.send(JSON.stringify(msg));
                };
            } else {
                // For student, "broadcast" sends to teacher
                App.broadcast = (msg) => {
                    const conn = connectionsRef.current.get(boardId);
                    if (conn && conn.open) conn.send(JSON.stringify(msg));
                };
            }

            // Store listener for local changes
            const cleanStore = store.listen(e => {
                if(e.source !== 'user') return;
                const changes = {added:{}, updated:{}, removed:{}};
                let has = false;
                const allow = ['shape','asset','instance_presence'];
                
                const chk = (r, op) => {
                    if(allow.includes(r.typeName)) {
                        if(op==='add') changes.added[r.id] = r;
                        if(op==='rem') changes.removed[r.id] = r;
                        has = true;
                    }
                };
                for(let k in e.changes.added) chk(e.changes.added[k], 'add');
                for(let k in e.changes.removed) chk(e.changes.removed[k], 'rem');
                for(let k in e.changes.updated) {
                    const r = e.changes.updated[k][1];
                    if(allow.includes(r.typeName)) { changes.updated[k] = e.changes.updated[k]; has = true; }
                }
                if(has) App.broadcast({type:'update', changes});
            });

            return () => {
                cleanStore();
                if(heartbeatIntervalRef.current) clearInterval(heartbeatIntervalRef.current);
                if(retryTimeoutRef.current) clearTimeout(retryTimeoutRef.current);
                peer.destroy();
                connectionsRef.current.clear();
            };
        }, [editor, magnetZone]); // Dependencies

        const handleSetTimer = (end) => {
            setTimer(end);
            App.broadcast({ type: 'timer', end });
        };

        if(role === 'student' && !isCoHost) {
            return React.createElement(StudentView, { store });
        }

        return React.createElement('div', { className: 'layer' },
            React.createElement(Tldraw, {
                store,
                onMount: (e) => {
                    setEditor(e);
                    e.user.updateUserPreferences({ name: `${App.avatar} ${App.username}` });
                    e.updateInstanceState({ meta: { peerId, isCoHost }});
                },
                components: {
                    InFrontOfTheCanvas: () => React.createElement('div', { className: 'layer pointer-events-none' },
                        React.createElement(TimerDisplay, { endTime: timer }),
                        role==='teacher' && editor && React.createElement(TeacherTools, { editor, boardId, onSetTimer: handleSetTimer }),
                        role==='teacher' && editor && React.createElement(UserRoster, { editor }),
                        role==='teacher' && editor && React.createElement(AutoLayoutEngine, { editor }),
                        React.createElement('button', { 
                            className: 'btn pointer-events-auto', 
                            style: { position:'absolute', top:10, left:10, padding:'6px 12px', fontSize:'0.8rem' },
                            onClick: () => location.reload() 
                        }, 'üè† Exit')
                    )
                }
            })
        );
    }

    window.App = {
        role: null, avatar: 'üê∂', username: 'Guest',
        init() {
            const a = document.getElementById('avatar-list');
            AVATARS.forEach((x,i) => {
                const d = document.createElement('div');
                d.className = `avatar-opt ${i===0?'selected':''}`;
                d.innerText = x;
                d.onclick = () => { document.querySelectorAll('.avatar-opt').forEach(el=>el.classList.remove('selected')); d.classList.add('selected'); this.avatar = x; };
                a.appendChild(d);
            });
            const p = new URLSearchParams(location.search);
            if(p.get('join')) { document.getElementById('join-id').value = p.get('join'); this.setRole('student'); }
        },
        setRole(r) {
            this.role = r;
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('role-'+r).classList.add('selected');
            document.getElementById('setup').classList.remove('hidden');
            document.getElementById('teacher-ops').classList.toggle('hidden', r!=='teacher');
            document.getElementById('student-ops').classList.toggle('hidden', r!=='student');
            if(r==='teacher') this.loadRecents();
        },
        async loadRecents() {
            const l = await DB.list();
            const c = document.getElementById('recent-list');
            c.innerHTML = l.length > 0 ? '' : 'No recent boards.';
            l.forEach(b => {
                const d = document.createElement('div');
                d.className = 'recent-item';
                d.innerHTML = `<b>${new Date(b.d).toLocaleDateString()}</b> ID:${b.id.slice(0,5)}`;
                d.onclick = () => this.launch(b.id, b.snap);
                c.appendChild(d);
            });
        },
        start() {
            if(this.role==='student' && !document.getElementById('join-id').value) return alert("Enter ID");
            const id = this.role==='teacher' ? uniqueId() : document.getElementById('join-id').value;
            this.launch(id, null);
        },
        async launch(id, snap) {
            this.username = document.getElementById('username').value || (this.role==='teacher'?'Teacher':'Student');
            if(!snap && this.role==='teacher') snap = null; 
            
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('workspace').classList.remove('hidden');
            history.replaceState({},'',location.pathname);
            const peerId = this.role === 'teacher' ? id : uniqueId();
            const root = createRoot(document.getElementById('workspace'));
            root.render(React.createElement(AppCore, { role: this.role, boardId: id, snap, peerId }));
        },
        ui: {
            share(id) {
                const url = `${location.origin}${location.pathname}?join=${id}`;
                QRCode.toCanvas(document.getElementById('qr-canvas'), url, {width:200}, ()=>{});
                document.getElementById('share-id').innerText = id;
                document.getElementById('modal-share').classList.remove('hidden');
            },
            closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); },
            toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'), 2000); }
        },
        scanQR() {
            document.getElementById('modal-scan').classList.remove('hidden');
            this.scanner = new Html5Qrcode("reader");
            this.scanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, (t)=>{
                try {
                    const u = new URL(t);
                    const id = u.searchParams.get('join');
                    if(id) { document.getElementById('join-id').value = id; this.stopScan(); this.start(); }
                } catch(e) { App.ui.toast("Invalid QR Code"); }
            }, ()=>{});
        },
        stopScan() {
            if(this.scanner) this.scanner.stop().then(()=>this.scanner.clear());
            document.getElementById('modal-scan').classList.add('hidden');
        }
    };
    App.init();
</script>
</body>
</html>